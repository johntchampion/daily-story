<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link rel="apple-touch-icon" href="/images/icon.png" />
    <title><%= language %> (<%= level %>) - Daily Story</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/story.css">
</head>
<body>
    <div class="container story">
        <h1 class="story-title"><%= title %></h1>
        <time class="story-date" datetime="<%= dateISO %>"><%= date %></time>
        <div class="story-audio-controls" aria-label="Story audio controls">
            <button class="btn btn-primary story-audio-btn" id="playStoryBtn" type="button">Play</button>
            <button class="btn btn-secondary story-audio-btn" id="pauseStoryBtn" type="button">Pause</button>
            <button class="btn btn-secondary story-audio-btn" id="resetStoryBtn" type="button">Reset</button>
        </div>
        <% if (messages && messages.length > 0) { %>
            <% messages.forEach((message, index) => { %>
                <div class="message">
                    <div class="sender"><%= message.sender || 'Unknown' %></div>
                    <div><%= message.text %></div>
                </div>
            <% }) %>
        <% } else if (story) { %>
            <p><%= story %></p>
        <% } %>

        <% if (otherLevels && otherLevels.length > 0) { %>
            <div class="other-levels">
                <h3>Try Other Skill Levels</h3>
                <ul class="level-links">
                    <% otherLevels.forEach(level => { %>
                        <li>
                            <a href="<%= level.url %>">
                                <span class="level-badge"><%= level.level %></span>
                                <span class="level-title"><%= level.title %></span>
                            </a>
                        </li>
                    <% }) %>
                </ul>
            </div>
        <% } %>
    </div>

    <% if (questions && questions.length > 0) { %>
        <div class="questions">
            <h2>Quiz Questions</h2>
            <% questions.forEach((q, index) => { %>
                <%
                    // Create array of indices to shuffle
                    const indices = q.options.map((_, i) => i);
                    // Fisher-Yates shuffle
                    for (let i = indices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [indices[i], indices[j]] = [indices[j], indices[i]];
                    }
                    // Create shuffled options array
                    const shuffledOptions = indices.map(i => q.options[i]);
                    // Find new position of correct answer
                    const newCorrectIndex = indices.indexOf(q.correctAnswer);
                %>
                <div class="question" data-question-index="<%= index %>">
                    <h3>Question <%= index + 1 %>: <%= q.question %></h3>
                    <ul class="options" data-correct-answer="<%= newCorrectIndex %>">
                        <% shuffledOptions.forEach((option, optIndex) => { %>
                            <li data-option-index="<%= optIndex %>" onclick="selectAnswer(this)">
                                <strong><%= String.fromCharCode(65 + optIndex) %>.</strong> <%= option %>
                            </li>
                        <% }) %>
                    </ul>
                </div>
            <% }) %>
        </div>
    <% } %>

    <p class="bookmark-message">Bookmark this page and come back tomorrow for a new story!</p>
    <div class="home-link-container">
        <a href="/" class="home-link">Select Language & Skill Level</a>
        <span class="link-separator">â€¢</span>
        <a href="/about" class="home-link">About</a>
    </div>

    <script>
        const storyMessages = <%- JSON.stringify(messages || []) %>;
        const storyText = <%- JSON.stringify(story || '') %>;
        const storySegments = storyMessages.length
            ? storyMessages.map(message => ({
                speaker: message.sender || 'Narrator',
                text: message.text
            }))
            : (storyText ? [{ speaker: 'Narrator', text: storyText }] : []);

        const playButton = document.getElementById('playStoryBtn');
        const pauseButton = document.getElementById('pauseStoryBtn');
        const resetButton = document.getElementById('resetStoryBtn');

        let currentIndex = 0;
        let utterances = [];
        let isSpeaking = false;

        function updateButtons() {
            const hasSpeech = utterances.length > 0;
            const isPaused = speechSynthesis.paused;
            playButton.disabled = !hasSpeech || (speechSynthesis.speaking && !isPaused);
            pauseButton.disabled = !hasSpeech || !speechSynthesis.speaking || isPaused;
            resetButton.disabled = !hasSpeech || (!speechSynthesis.speaking && !isPaused && currentIndex === 0);
        }

        function assignVoices(voices) {
            const speakers = [...new Set(storySegments.map(segment => segment.speaker))];
            const voiceMap = new Map();
            speakers.forEach((speaker, index) => {
                if (voices.length > 0) {
                    voiceMap.set(speaker, voices[index % voices.length] || null);
                } else {
                    voiceMap.set(speaker, null);
                }
            });
            utterances = storySegments.map(segment => {
                const utterance = new SpeechSynthesisUtterance(segment.text);
                const assignedVoice = voiceMap.get(segment.speaker);
                if (assignedVoice) {
                    utterance.voice = assignedVoice;
                }
                utterance.onend = () => {
                    if (currentIndex < utterances.length - 1) {
                        currentIndex += 1;
                        speakCurrent();
                    } else {
                        isSpeaking = false;
                        updateButtons();
                    }
                };
                utterance.onerror = () => {
                    isSpeaking = false;
                    updateButtons();
                };
                return utterance;
            });
            updateButtons();
        }

        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            assignVoices(voices);
        }

        function speakCurrent() {
            if (!utterances.length || currentIndex >= utterances.length) {
                return;
            }
            isSpeaking = true;
            speechSynthesis.speak(utterances[currentIndex]);
            updateButtons();
        }

        if (!('speechSynthesis' in window)) {
            playButton.disabled = true;
            pauseButton.disabled = true;
            resetButton.disabled = true;
        } else if (storySegments.length === 0) {
            updateButtons();
        } else {
            loadVoices();
            speechSynthesis.onvoiceschanged = loadVoices;
            updateButtons();
        }

        playButton.addEventListener('click', () => {
            if (!utterances.length) {
                return;
            }
            if (speechSynthesis.speaking && speechSynthesis.paused) {
                speechSynthesis.resume();
                updateButtons();
                return;
            }
            if (speechSynthesis.speaking) {
                return;
            }
            speakCurrent();
        });

        pauseButton.addEventListener('click', () => {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
                updateButtons();
            }
        });

        resetButton.addEventListener('click', () => {
            speechSynthesis.cancel();
            currentIndex = 0;
            isSpeaking = false;
            updateButtons();
        });

        function selectAnswer(element) {
            const optionsList = element.parentElement;
            const allOptions = optionsList.querySelectorAll('li');

            // Check if this question has already been answered
            if (optionsList.classList.contains('answered')) {
                return;
            }

            const selectedIndex = parseInt(element.getAttribute('data-option-index'));
            const correctIndex = parseInt(optionsList.getAttribute('data-correct-answer'));

            // Mark as answered to prevent further clicks
            optionsList.classList.add('answered');

            // Disable all options
            allOptions.forEach(option => {
                option.classList.add('disabled');
            });

            // Highlight the selected answer
            if (selectedIndex === correctIndex) {
                element.classList.add('correct');
            } else {
                element.classList.add('incorrect');
                // Also show the correct answer
                allOptions[correctIndex].classList.add('correct');
            }
        }
    </script>
</body>
</html>
